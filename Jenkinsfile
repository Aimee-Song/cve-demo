pipeline {
    agent any
	tools {
		maven 'maven3.6.1'
		jdk 'jdk1.8'
	}
	environment {
		registryUrl= "134.175.147.222:5000"
		artifactId =readMavenPom().getArtifactId().toLowerCase()
		image_tag = readMavenPom().getVersion()
		image_repository = "${registryUrl}/${artifactId}"
    }
    stages{
	    stage('prepare'){
			steps {
				echo "registryUrl: ${registryUrl} ,image_repository: ${image_repository} ,image_tag : ${image_tag}"
			}
		}
        stage('Build project') {
            steps {
                sh 'mvn clean package -DskipTests'
            }
        }
		stage('Build & Push Image') {
            steps {
					dir('target'){
						script {
							def app = docker.build('${image_repository}:${image_tag}')
							app.push('${image_tag}')
						    app.push('latest')
						}
					}
            }
        }
		stage('deploy') {
			steps {
				echo "deploy"
			}
		}
    }
}
